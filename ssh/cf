#!/bin/bash

# ┌───────────────────────────────────────────────────────────────────┐
# │                    мαυт cσ∂єя DOMAIN MANAGER                     │
# ├───────────────────────────────────────────────────────────────────┤
# │  Telegram: @maut_coder_bot | Channel: https://t.me/maut_vpn      │
# └───────────────────────────────────────────────────────────────────┘

# Install necessary packages if not already installed
apt update
apt install -y jq curl

# Function to print error messages and exit
function error_exit {
    echo -e "\e[36m┌───────────────────────────────────────────────────────────────────┐\e[0m"
    echo -e "\e[36m│\e[0m  \e[1;91m✗ ERROR:\e[0m $1                                        \e[36m│\e[0m"
    echo -e "\e[36m└───────────────────────────────────────────────────────────────────┘\e[0m"
    exit 1
}

# Display banner
echo -e "\e[36m┌───────────────────────────────────────────────────────────────────┐\e[0m"
echo -e "\e[36m│\e[0m                  \e[1;96mDOMAIN MANAGEMENT SYSTEM\e[0m                  \e[36m│\e[0m"
echo -e "\e[36m│\e[0m                     \e[1;97mмαυт cσ∂єя Panel\e[0m                       \e[36m│\e[0m"
echo -e "\e[36m├───────────────────────────────────────────────────────────────────┤\e[0m"
echo -e "\e[36m│\e[0m  Owner : \e[94mмαυт cσ∂єя\e[0m (\e[94m@maut_coder_bot\e[0m)                         \e[36m│\e[0m"
echo -e "\e[36m│\e[0m  Channel: \e[94mhttps://t.me/maut_vpn\e[0m                              \e[36m│\e[0m"
echo -e "\e[36m└───────────────────────────────────────────────────────────────────┘\e[0m"

# Constants and variables
DOMAIN="nt-vps.com"
SUB_DOMAIN="MC-$(head /dev/urandom | tr -dc a-z0-9 | head -c 5).vipssh.online"
CF_ID="foodv776@gmail.com"
CF_KEY="ed22c2673b2e8ee27c776db85e6546f4a510c"  # Update with your API token
IP=$(curl -s ipinfo.io/ip)
API_URL="https://api.cloudflare.com/client/v4"
ZONE_ID="195c976c61503b6d1d6cf1fec47edf0a"  # Update with your zone ID

# Display system info
echo ""
echo -e "\e[36m┌───────────────────────────────────────────────────────────────────┐\e[0m"
echo -e "\e[36m│\e[0m                    \e[1;97mSYSTEM INFORMATION\e[0m                       \e[36m│\e[0m"
echo -e "\e[36m├───────────────────────────────────────────────────────────────────┤\e[0m"
echo -e "\e[36m│\e[0m  \e[97m• Server IP     : \e[1;93m$IP\e[0m                              \e[36m│\e[0m"
echo -e "\e[36m│\e[0m  \e[97m• Generating Domain...\e[0m                                    \e[36m│\e[0m"
echo -e "\e[36m└───────────────────────────────────────────────────────────────────┘\e[0m"

# Function to update DNS record in Cloudflare
function update_dns_record {
    local zone_id="$1"
    local record_id="$2"
    
    echo -e "\e[36m│\e[0m  \e[97m• Updating DNS Record...\e[0m                                 \e[36m│\e[0m"
    
    local response=$(curl -sX PUT "${API_URL}/zones/${zone_id}/dns_records/${record_id}" \
                    -H "Authorization: Bearer ${CF_KEY}" \
                    -H "Content-Type: application/json" \
                    --data '{"type":"A","name":"'${SUB_DOMAIN}'","content":"'${IP}'","ttl":null,"proxied":false}') || error_exit "Failed to execute API request: PUT ${API_URL}/zones/${zone_id}/dns_records/${record_id}"
    echo "$response"
}

# Main script execution
set -euo pipefail

echo -e "\e[36m┌───────────────────────────────────────────────────────────────────┐\e[0m"
echo -e "\e[36m│\e[0m                    \e[1;97mPROCESSING DOMAIN\e[0m                         \e[36m│\e[0m"
echo -e "\e[36m├───────────────────────────────────────────────────────────────────┤\e[0m"
echo -e "\e[36m│\e[0m  \e[97m• Generating Domain: \e[1;93m$SUB_DOMAIN\e[0m                    \e[36m│\e[0m"

# Check if DNS record exists
RECORD=$(curl -sX GET "${API_URL}/zones/${ZONE_ID}/dns_records?name=${SUB_DOMAIN}" \
     -H "Authorization: Bearer ${CF_KEY}" \
     -H "Content-Type: application/json" | jq -r .result[0].id)

if [[ "${#RECORD}" -le 10 ]]; then
    echo -e "\e[36m│\e[0m  \e[97m• Creating new DNS record...\e[0m                             \e[36m│\e[0m"
    # Create DNS record if it doesn't exist
    RECORD=$(curl -sX POST "${API_URL}/zones/${ZONE_ID}/dns_records" \
    -H "Authorization: Bearer ${CF_KEY}" \
    -H "Content-Type: application/json" \
    --data '{"type":"A","name":"'${SUB_DOMAIN}'","content":"'${IP}'","proxied":false}' | jq -r .result.id) || error_exit "Failed to create DNS record in Cloudflare."
else
    echo -e "\e[36m│\e[0m  \e[97m• Updating existing DNS record...\e[0m                        \e[36m│\e[0m"
fi

# Update DNS record with current IP and auto TTL
update_dns_record "$ZONE_ID" "$RECORD"

# Output confirmation
echo -e "\e[36m├───────────────────────────────────────────────────────────────────┤\e[0m"
echo -e "\e[36m│\e[0m                    \e[1;92mDOMAIN CONFIGURED\e[0m                         \e[36m│\e[0m"
echo -e "\e[36m├───────────────────────────────────────────────────────────────────┤\e[0m"
echo -e "\e[36m│\e[0m  \e[97m• Domain        : \e[1;93m$SUB_DOMAIN\e[0m                       \e[36m│\e[0m"
echo -e "\e[36m│\e[0m  \e[97m• Server IP     : \e[1;93m$IP\e[0m                              \e[36m│\e[0m"
echo -e "\e[36m│\e[0m  \e[97m• Status        : \e[1;92mACTIVE ✓\e[0m                               \e[36m│\e[0m"
echo -e "\e[36m├───────────────────────────────────────────────────────────────────┤\e[0m"

# Update configuration files (ensure directories exist)
mkdir -p /root/xray/
echo "$SUB_DOMAIN" > /root/xray/scdomain
echo "IP=$SUB_DOMAIN" > /var/lib/ipvps.conf
echo "$SUB_DOMAIN" > /root/domain
echo "$SUB_DOMAIN" > /etc/xray/domain
echo "$SUB_DOMAIN" > /etc/v2ray/domain
echo "$SUB_DOMAIN" > /root/scdomain
echo "$SUB_DOMAIN" > /root/xray/scdomain

echo -e "\e[36m│\e[0m  \e[97m• Configuration files updated successfully\e[0m                  \e[36m│\e[0m"
echo -e "\e[36m├───────────────────────────────────────────────────────────────────┤\e[0m"
echo -e "\e[36m│\e[0m  \e[94mOwner: мαυт cσ∂єя | Telegram: @maut_coder_bot\e[0m              \e[36m│\e[0m"
echo -e "\e[36m└───────────────────────────────────────────────────────────────────┘\e[0m"

# Cleanup
rm -rf cf
sleep 1

echo ""
echo -e "\e[92m✓ Domain setup completed successfully!\e[0m"